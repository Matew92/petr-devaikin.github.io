<html>
    <head>
        <script src="data/data.js"></script>
    </head>
    <body>
        <div id="div1"></div>
        <br/>
        <div id="div2"></div>


        <script>
            var convocations2 = {};
            var fractions = {};
            var parties = {};
            var deputies = {};
            var transitions = {};
            var fr_arr = [];

            for (var i = 0; i < convocations.length; i++) {
                var c = convocations[i];
                var new_c = {
                    id: c.Id,
                    number: c.Id,
                    years: c.Name
                }
                convocations2[c.Id] = new_c;

                for (var j = 0; j < c.Fractions.length; j++) {
                    var f = c.Fractions[j];
                    var new_f = {
                        id: f.Id,
                        order: f.Order,
                        partyId: f.Party.Id,
                        size: f.DeputatsCount,
                        convocationId: new_c.id
                    }
                    fractions[f.Id] = new_f;
                    fr_arr.push(new_f);

                    if (parties[f.Party.Id] === undefined)
                        parties[f.Party.Id] = {
                            id: f.Party.Id,
                            name: f.Party.Name
                        }

                    for (var k in f.Deputats) {
                        var deputat = f.Deputats[k];
                        if (deputies[deputat.Id] === undefined)
                            deputies[deputat.Id] = {
                                id: deputat.Id,
                                name: deputat.Name,
                                fractionIds: [f.Id]
                            }
                        else {
                            var prevFractionId = deputies[deputat.Id].fractionIds[deputies[deputat.Id].fractionIds.length - 1];
                            deputies[deputat.Id].fractionIds.push(f.Id);
                            if (transitions[prevFractionId] === undefined) {
                                transitions[prevFractionId] = {}
                                transitions[prevFractionId][f.Id] = {
                                    from: prevFractionId,
                                    to: f.Id,
                                    number: 1
                                }
                            }
                            else if (transitions[prevFractionId][f.Id] === undefined)
                                transitions[prevFractionId][f.Id] = {
                                    from: prevFractionId,
                                    to: f.Id,
                                    number: 1
                                }
                            else
                                transitions[prevFractionId][f.Id].number++;
                        }
                    }
                }
            }

            for (var i in fractions) {
                var f = fractions[i];
                fractions[i].offset = fr_arr.filter(a => a.convocationId == f.convocationId && a.order < f.order).reduce((a,b) => a + b.size, 0);
            }

            document.getElementById("div1").innerText = JSON.stringify(transitions);
        </script>
    </body>
</html>

